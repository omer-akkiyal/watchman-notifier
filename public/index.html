<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchman | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl p-8 border border-slate-700">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-green-500">Watchman üëÅÔ∏è‚Äçüó®Ô∏è</h1>
            <p class="text-slate-400 text-sm mt-2">GitHub Bildirimlerini WhatsApp'a Baƒüla</p>
        </header>

        <div class="space-y-4">
            <div>
                <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">GitHub Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="github" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="omer-akkiyal">
            </div>

            <div>
                <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">WhatsApp Numarasƒ±</label>
                <input type="text" id="phone" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="905550200422">
            </div>

            <div>
                <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Bildirim Hedefi</label>
                <select id="targetType" onchange="toggleGroupList()" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none">
                    <option value="private">√ñzel Mesaj (DM)</option>
                    <option value="group">WhatsApp Grubu</option>
                </select>
            </div>

            <div id="groupContainer" class="hidden animate-fade-in">
                <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Grup Se√ßin</label>
                <select id="groupList" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none border-green-900">
                    <option>Gruplar y√ºkleniyor...</option>
                </select>
                <button onclick="loadGroups()" class="text-xs text-green-500 mt-1 hover:underline">Listeyi Yenile</button>
            </div>

            <div>
                <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Eri≈üim Anahtarƒ± (Secret Key)</label>
                <input type="password" id="secret" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 transition">
            </div>

            <button onclick="register()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg mt-4 transition duration-300 transform hover:scale-105 active:scale-95 shadow-lg shadow-green-900/20">
                Watchman'i Aktif Et
            </button>
        </div>

        <div id="result" class="hidden mt-6 p-4 bg-slate-900 border border-green-500/30 rounded-lg">
            <p class="text-green-400 text-sm font-medium">‚úÖ Ba≈üarƒ±yla baƒülandƒ±!</p>
            <p class="text-xs text-slate-400 mt-2">GitHub Webhook URL'in:</p>
            <code id="webhookLink" class="block bg-black p-2 rounded mt-1 text-[10px] text-green-300 break-all select-all"></code>
        </div>
    </div>

    <script>
        function toggleGroupList() {
            const type = document.getElementById('targetType').value;
            const container = document.getElementById('groupContainer');
            if(type === 'group') {
                container.classList.remove('hidden');
                loadGroups();
            } else {
                container.classList.add('hidden');
            }
        }

        async function loadGroups() {
            const res = await fetch('/api/groups');
            const groups = await res.json();
            const select = document.getElementById('groupList');
            select.innerHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        }

        async function register() {
            const data = {
                githubUsername: document.getElementById('github').value,
                phoneNumber: document.getElementById('phone').value,
                targetType: document.getElementById('targetType').value,
                targetId: document.getElementById('targetType').value === 'group' ? document.getElementById('groupList').value : null,
                secretKey: document.getElementById('secret').value
            };

            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await res.json();
            if(res.ok) {
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('webhookLink').innerText = `https://watchman-notifier.onrender.com/webhook/${data.githubUsername}`;
            } else {
                alert(result.error);
            }
        }
    </script>
</body>
</html>